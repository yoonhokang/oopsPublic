# Deep Analysis: Persisting 403 Forbidden Error

**Date:** 2026-02-19 17:50
**Topic:** Why 403? (Rules are Open, Token is Valid)

## 1. 현재 상황 (Status)
- **Token:** 유효 (Project ID `oopspublic` 일치).
- **Rules:** `allow read, write: if request.auth != null;` (로그인만 하면 다 됨).
- **Network:** Seoul Region 엔드포인트 도달 성공.
- **Result:** **403 Forbidden (Permission Denied)**

## 2. 유력한 원인 (Probable Causes)

### 2.1. API Key Restrictions (가장 유력)
가장 흔한 원인입니다. 프로젝트 생성 시 자동 생성된 API Key는 때때로 **"사용 가능한 API"**가 제한되어 있습니다.
- **상황:** API Key가 `Identity Toolkit (Auth)`는 허용하지만, `Cloud Firestore API`는 허용 목록에 없을 수 있습니다.
- **증상:** Security Rules까지 가기도 전에, 구글 게이트웨이에서 403으로 막아버립니다.

### 2.2. App Check Enforcement
Firebase Console의 **App Check** 기능이 켜져 있다면?
- **상황:** 등록된 앱(iOS/Android/Web SDK)에서 오는 요청만 허용하고, 우리처럼 `fetch`로 직접 보내는 REST 요청은 "신뢰할 수 없는 출처"로 간주하여 차단합니다.
- **증상:** 유효한 토큰이 있어도 403 또는 401이 발생합니다.

### 2.3. Rule Propagation Time
- **상황:** 룰 변경 후 전세계 엣지 서버에 전파되는데 최대 1~2분이 소요됩니다.
- **판단:** 이미 시간이 꽤 지나서 가능성은 낮습니다.

## 3. 해결을 위한 심층 테스트 계획 (Troubleshoot Upgrade)
`troubleshoot.html`에 다음 기능을 추가하여 원인을 핀셋으로 집어내겠습니다.

1.  **Metadata Access Test:**
    - 데이터(`documents`)가 아니라 DB 정보(`databases/default`)를 조회합니다.
    - Security Rules의 영향을 받지 않고, 오직 **IAM/API Key 권한**만 체크합니다.
    - 여기서 막히면 -> **API Key 설정 문제** (GCP Console에서 수정 필요).

2.  **Verification of "Default" Rule Matching:**
    - 규칙 파일 상단의 `match /databases/{database}/documents`가 URL의 `default`와 매칭되는지 확인하기 위해, 알려진 경로로 찔러봅니다.

## 4. 사용자 질문에 대한 답변
**Q: 보안 룰 캡처 내용에 문제가 있나요?**
A: **아니요, 문법적으로 완벽합니다.**
- `match /{document=**}`는 하위 모든 경로를 포함하므로, `users/{uid}` 접근도 당연히 허용되어야 정상입니다.
- 즉, 룰 내용(Software Logic)의 문제가 아니라, 룰 적용을 받는 **인프라(Gateway/Config)**의 문제일 확률이 높습니다.
